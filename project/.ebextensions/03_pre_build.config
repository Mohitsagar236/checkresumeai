files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_build_app.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      
      echo "=== Starting build process ==="
      
      # Set PATH to include npm global binaries
      export PATH=$PATH:/usr/lib/node_modules/.bin:/usr/local/bin
      
      cd /var/app/staging
      
      echo "=== Current directory contents ==="
      ls -la
      
      echo "=== Installing root dependencies ==="
      npm install
      
      echo "=== Checking if backend directory exists ==="
      if [ -d "backend" ]; then
        echo "Backend directory found, installing dependencies..."
        cd backend
        npm install --include=dev
        
        echo "=== Building backend TypeScript ==="
        npm run build
        
        echo "=== Going back to root ==="
        cd ..
        
        echo "=== Creating necessary directories ==="
        mkdir -p backend/logs backend/uploads
        chmod -R 755 backend/logs backend/uploads
      else
        echo "ERROR: Backend directory not found!"
        echo "Available directories:"
        ls -la
        exit 1
      fi
      
      echo "=== Building frontend ==="
      # Build frontend
      npm run build:frontend || echo "Frontend build failed, continuing..."
      
      echo "=== Build process completed successfully ==="
