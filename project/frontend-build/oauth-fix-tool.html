<!DOCTYPE html>
<html>
<head>
    <title>CheckResumeAI OAuth Fix Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        code {
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }
        .results {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            color: #d32f2f;
        }
        .success {
            color: #388e3c;
        }
        .warning {
            color: #f57c00;
            font-weight: bold;
        }
        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>CheckResumeAI OAuth Fix Tool</h1>
    
    <div class="info-box">
        <p><span class="warning">⚠️ Error:</span> <code>http://localhost:3000/?error=invalid_request&error_code=bad_oauth_state&error_description=OAuth+callback+with+invalid+state</code></p>
        <p>This tool helps fix the "bad_oauth_state" error that occurs during OAuth sign-in.</p>
    </div>

    <div class="card">
        <h2>Step 1: Diagnose Current Environment</h2>
        <p>Check if you're running on the correct port and environment:</p>
        <button id="diagBtn" class="btn">Run Diagnostics</button>
        <div id="diagResults" class="results"></div>
    </div>
    
    <div class="card">
        <h2>Step 2: Clear OAuth State Data</h2>
        <p>Click the button below to clear all OAuth and Supabase state data from your browser:</p>
        <button id="clearStateBtn" class="btn">Clear OAuth State</button>
        <div id="clearResults" class="results"></div>
    </div>

    <div class="card">
        <h2>Step 3: Try Authentication Again</h2>
        <p>Once the state is cleared, you can navigate to the login page:</p>
        <a href="/login" class="btn" id="loginBtn">Go to Login Page</a>
    </div>

    <div class="card" id="advanced" style="display: none;">
        <h2>Advanced: Direct State Reset</h2>
        <p>Copy and run this code in your browser console (F12) if the button above doesn't work:</p>
        <pre class="results">
// Clear localStorage
Object.keys(localStorage).forEach(key => {
  if(key.includes('supabase') || key.includes('oauth') || key.includes('auth')) {
    console.log('Removing from localStorage:', key);
    localStorage.removeItem(key);
  }
});

// Clear sessionStorage
Object.keys(sessionStorage).forEach(key => {
  if(key.includes('supabase') || key.includes('oauth') || key.includes('auth')) {
    console.log('Removing from sessionStorage:', key);
    sessionStorage.removeItem(key);
  }
});

console.log('OAuth state cleared. You can now try logging in again.');
        </pre>
        <button id="copyCodeBtn" class="btn">Copy Code</button>
        <span id="copyResult"></span>
    </div>

    <script>
        // Show advanced section after a delay
        setTimeout(() => {
            document.getElementById('advanced').style.display = 'block';
        }, 8000);
        
        // Diagnostics function
        document.getElementById('diagBtn').addEventListener('click', function() {
            const resultsElem = document.getElementById('diagResults');
            try {
                const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
                const isCorrectPort = currentPort === '3000';
                
                const envInfo = {
                    url: window.location.href,
                    port: currentPort,
                    isCorrectPort: isCorrectPort,
                    hostname: window.location.hostname,
                    protocol: window.location.protocol,
                    userAgent: navigator.userAgent
                };
                
                // Check for existing OAuth state
                const existingState = {
                    localStorage: {},
                    sessionStorage: {}
                };
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('supabase') || key.includes('oauth') || key.includes('auth'))) {
                        existingState.localStorage[key] = localStorage.getItem(key);
                    }
                }
                
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && (key.includes('supabase') || key.includes('oauth') || key.includes('auth'))) {
                        existingState.sessionStorage[key] = sessionStorage.getItem(key);
                    }
                }
                
                // Build the diagnostic result
                let output = '';
                
                // Port check
                if (isCorrectPort) {
                    output += '<span class="success">✅ Running on correct port (3000)</span>\n';
                } else {
                    output += `<span class="error">❌ Wrong port! Current: ${currentPort}, Expected: 3000</span>\n`;
                    output += '   - This is likely causing the OAuth state mismatch\n';
                    output += '   - Please restart app with: npm run dev -- --port 3000\n\n';
                }
                
                // Environment check
                output += `\nCurrent URL: ${envInfo.url}\n`;
                output += `Browser: ${envInfo.userAgent.split(') ')[0]})\n`;
                
                // State check
                const hasStoredState = Object.keys(existingState.localStorage).length > 0 || 
                                      Object.keys(existingState.sessionStorage).length > 0;
                
                if (hasStoredState) {
                    output += '\n<span class="warning">⚠️ Found existing OAuth state that may be causing issues:</span>\n';
                    
                    if (Object.keys(existingState.localStorage).length > 0) {
                        output += `\nLocalStorage OAuth items:\n`;
                        Object.keys(existingState.localStorage).forEach(key => {
                            output += `   - ${key}\n`;
                        });
                    }
                    
                    if (Object.keys(existingState.sessionStorage).length > 0) {
                        output += `\nSessionStorage OAuth items:\n`;
                        Object.keys(existingState.sessionStorage).forEach(key => {
                            output += `   - ${key}\n`;
                        });
                    }
                    
                    output += '\nRecommendation: Click "Clear OAuth State" below\n';
                } else {
                    output += '\n<span class="success">✅ No existing OAuth state found</span>\n';
                }
                
                resultsElem.innerHTML = output;
            } catch (err) {
                resultsElem.innerHTML = `<span class="error">❌ Error running diagnostics: ${err.message}</span>`;
            }
        });
        
        // Clear state function
        document.getElementById('clearStateBtn').addEventListener('click', function() {
            const resultsElem = document.getElementById('clearResults');
            try {
                // Clear from localStorage
                const localStorageKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('supabase') || key.includes('oauth') || key.includes('auth'))) {
                        localStorageKeys.push(key);
                        localStorage.removeItem(key);
                    }
                }
                
                // Clear from sessionStorage
                const sessionStorageKeys = [];
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && (key.includes('supabase') || key.includes('oauth') || key.includes('auth'))) {
                        sessionStorageKeys.push(key);
                        sessionStorage.removeItem(key);
                    }
                }
                
                if (localStorageKeys.length === 0 && sessionStorageKeys.length === 0) {
                    resultsElem.innerHTML = '<span class="success">✅ No OAuth state data found to clear</span>\n\nYou can now try logging in again.';
                } else {
                    resultsElem.innerHTML = `<span class="success">✅ Successfully cleared OAuth state data:</span>\n\nLocalStorage keys removed: ${localStorageKeys.join(', ') || 'none'}\n\nSessionStorage keys removed: ${sessionStorageKeys.join(', ') || 'none'}\n\nYou can now try logging in again.`;
                }
            } catch (err) {
                resultsElem.innerHTML = `<span class="error">❌ Error clearing state: ${err.message}</span>`;
            }
        });

        // Copy code function
        document.getElementById('copyCodeBtn').addEventListener('click', function() {
            const codeText = document.querySelector('#advanced pre').textContent;
            const resultSpan = document.getElementById('copyResult');
            
            navigator.clipboard.writeText(codeText).then(function() {
                resultSpan.textContent = ' ✓ Copied!';
                setTimeout(() => {
                    resultSpan.textContent = '';
                }, 2000);
            }, function() {
                resultSpan.textContent = ' ✗ Failed to copy';
            });
        });
        
        // Run diagnostics on load
        document.getElementById('diagBtn').click();
    </script>
</body>
</html>
